# OpenAIP Website

Next.js 16 web app for citizen, barangay, city, and admin portals.

For full monorepo setup (pipeline, database, and deployment), use the root guide:
- `../README.md`

## Quickstart

1. Install dependencies:
```bash
npm install
```

2. Create local env file:
```powershell
Copy-Item .env.local.example .env.local
```

3. Start dev server:
```bash
npm run dev
```

4. Open `http://localhost:3000`.

## Environment Flags

- `NEXT_PUBLIC_APP_ENV`
  - Allowed: `dev`, `staging`, `prod`
  - Default: `dev`
- `NEXT_PUBLIC_USE_MOCKS`
  - `true` forces mock repositories
  - If unset, mock mode is enabled when `NEXT_PUBLIC_APP_ENV=dev`

Repository selection is centralized in:
- `lib/config/appEnv.ts`
- `lib/repos/_shared/selector.ts`

## Dashboard Backend Notes

- Dashboard backend uses repo-domain architecture at `lib/repos/dashboard/*`.
- Reads are server-side and scope-filtered (`barangay` / `city`) using existing tables (`aips`, `projects`, `feedback`, `extraction_runs`, `aip_reviews`, `uploaded_files`, `profiles`).
- Dashboard AIP rows include uploader metadata from the latest `uploaded_files.is_current` record plus uploader `profiles.full_name`.
- Barangay write actions are strict:
  - draft create validates FY (`2000..2100`), enforces barangay scope, and is idempotent on duplicate FY
  - feedback reply validates body/length and parent eligibility, and routes reply creation through feedback threads repo for invariant + audit preservation
- Dashboard mock mode does not use a dashboard-only toggle; it follows global flags only (`NEXT_PUBLIC_APP_ENV`, `NEXT_PUBLIC_USE_MOCKS`).

## Quality Checks

```bash
npm run lint
npm run test:ui
npx tsc --noEmit
node scripts/repo-smoke/run.js
```

## Admin Auth Regression Checklist

1. Fresh admin sign-up/confirm (if applicable in your environment):
   - Complete staff/admin sign-up and confirmation flow.
   - Navigate to `/admin` and confirm dashboard data is visible immediately without manual refresh.
2. Fresh admin sign-in:
   - Sign in at `/admin/sign-in`.
   - Confirm `/admin` dashboard data is visible immediately on first load without manual refresh.
3. First client-side nav to dashboard:
   - From any authenticated admin page, click `Dashboard` in the admin sidebar.
   - Confirm dashboard data appears on first render without manual refresh.
4. Role guard:
   - Sign in as non-admin and request `/admin`.
   - Confirm redirect to the unauthorized page.
5. Refresh parity:
   - Hard refresh `/admin` and confirm values remain consistent with first-load values.
6. Console/runtime:
   - Confirm no new client or server errors during the above scenarios.
7. Session heartbeat scope:
   - Visit a public route (for example `/`) while signed out.
   - Confirm the server log is not spammed with repeated `POST /auth/session/activity`.
   - Visit `/admin` while signed in and confirm heartbeat calls resume.
8. Admin sign-up policy:
   - Request `/admin/sign-up`.
   - Confirm redirect to `/admin/sign-in`.

## Notes

- Database schema and SQL patches are in `docs/sql`.
- Canonical schema file is `docs/sql/database-v2.sql`.
- The mirrored copy `docs/databasev2.txt` is kept synchronized with the canonical SQL file.
